<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‰ç«¯é…ç½®æµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f7fa;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .status { 
      padding: 8px 16px; 
      border-radius: 4px; 
      margin: 4px 0;
      display: inline-block;
    }
    .ok { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .warning { background: #fff3cd; color: #856404; }
    button {
      background: #409eff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #66b1ff; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>ğŸ” æ™ºèƒ½åˆåŒç®¡ç†ç³»ç»Ÿ - å‰ç«¯é…ç½®æµ‹è¯•</h1>
  
  <div class="card">
    <h2>ğŸ“‹ ç¯å¢ƒå˜é‡æ£€æŸ¥</h2>
    <div id="env-check"></div>
  </div>

  <div class="card">
    <h2>ğŸŒ API è¿æ¥æµ‹è¯•</h2>
    <button onclick="testBackendConnection()">æµ‹è¯•åç«¯è¿æ¥</button>
    <div id="api-result" class="hidden"></div>
  </div>

  <div class="card">
    <h2>ğŸ—„ï¸ Supabase è¿æ¥æµ‹è¯•</h2>
    <button onclick="testSupabaseConnection()">æµ‹è¯• Supabase è¿æ¥</button>
    <div id="supabase-result" class="hidden"></div>
  </div>

  <div class="card">
    <h2>ğŸ“¦ ä¾èµ–æ£€æŸ¥</h2>
    <div id="deps-check"></div>
  </div>

  <script type="module">
    // æ£€æŸ¥ç¯å¢ƒå˜é‡
    function checkEnvironmentVariables() {
      const container = document.getElementById('env-check');
      const envVars = [
        { name: 'VITE_SUPABASE_URL', required: true },
        { name: 'VITE_SUPABASE_ANON_KEY', required: true },
        { name: 'VITE_API_BASE_URL', required: true },
        { name: 'VITE_APP_TITLE', required: false },
        { name: 'VITE_ENABLE_AI_ANALYSIS', required: false },
        { name: 'VITE_DEBUG', required: false }
      ];

      let html = '';
      envVars.forEach(({ name, required }) => {
        const value = import.meta.env[name];
        const isSet = !!value && !value.includes('YOUR_') && !value.includes('your_');
        const status = isSet ? 'ok' : (required ? 'error' : 'warning');
        const statusText = isSet ? 'âœ… å·²é…ç½®' : (required ? 'âŒ æœªé…ç½®' : 'âš ï¸ ä½¿ç”¨é»˜è®¤å€¼');
        
        html += `<div class="status ${status}"><strong>${name}:</strong> ${statusText}</div>`;
        if (isSet && required) {
          html += `<small style="color: #666;">å€¼: ${value.substring(0, 50)}${value.length > 50 ? '...' : ''}</small><br>`;
        }
      });

      container.innerHTML = html;
    }

    // æµ‹è¯•åç«¯è¿æ¥
    window.testBackendConnection = async function() {
      const resultDiv = document.getElementById('api-result');
      resultDiv.className = '';
      resultDiv.innerHTML = '<div class="status warning">ğŸ”„ æ­£åœ¨æµ‹è¯•åç«¯è¿æ¥...</div>';
      resultDiv.classList.remove('hidden');

      try {
        const response = await fetch('/api/health');
        if (response.ok) {
          const data = await response.json();
          resultDiv.innerHTML = `<div class="status ok">âœ… åç«¯è¿æ¥æˆåŠŸ</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
        } else {
          resultDiv.innerHTML = `<div class="status error">âŒ åç«¯è¿æ¥å¤±è´¥ (${response.status})</div>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<div class="status error">âŒ åç«¯è¿æ¥å¤±è´¥: ${error.message}</div>`;
      }
    };

    // æµ‹è¯• Supabase è¿æ¥
    window.testSupabaseConnection = async function() {
      const resultDiv = document.getElementById('supabase-result');
      resultDiv.className = '';
      resultDiv.innerHTML = '<div class="status warning">ğŸ”„ æ­£åœ¨æµ‹è¯• Supabase è¿æ¥...</div>';
      resultDiv.classList.remove('hidden');

      try {
        // åŠ¨æ€å¯¼å…¥ Supabase å®¢æˆ·ç«¯
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2');
        
        const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
        const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
        
        if (!supabaseUrl || !supabaseAnonKey || supabaseUrl.includes('YOUR_') || supabaseAnonKey.includes('YOUR_')) {
          throw new Error('Supabase é…ç½®ä¸å®Œæ•´');
        }

        const supabase = createClient(supabaseUrl, supabaseAnonKey);
        const { data, error } = await supabase.from('users').select('count').limit(1);

        if (error) {
          throw new Error(error.message);
        }

        resultDiv.innerHTML = `<div class="status ok">âœ… Supabase è¿æ¥æˆåŠŸ</div><pre>æ•°æ®åº“å“åº”æ­£å¸¸</pre>`;
      } catch (error) {
        resultDiv.innerHTML = `<div class="status error">âŒ Supabase è¿æ¥å¤±è´¥: ${error.message}</div>`;
      }
    };

    // æ£€æŸ¥ä¾èµ–
    function checkDependencies() {
      const container = document.getElementById('deps-check');
      const deps = [
        { name: 'Vue', check: () => typeof window.Vue !== 'undefined' || import.meta.env.DEV },
        { name: 'Element Plus', check: () => import.meta.env.DEV }, // å¼€å‘ç¯å¢ƒæ£€æŸ¥
        { name: 'Axios', check: () => import.meta.env.DEV },
        { name: 'Supabase', check: () => import.meta.env.DEV }
      ];

      let html = '';
      deps.forEach(({ name, check }) => {
        const isAvailable = check();
        const status = isAvailable ? 'ok' : 'warning';
        const statusText = isAvailable ? 'âœ… å¯ç”¨' : 'âš ï¸ éœ€è¦éªŒè¯';
        html += `<div class="status ${status}"><strong>${name}:</strong> ${statusText}</div>`;
      });

      html += '<br><small style="color: #666;">æ³¨æ„: ä¾èµ–æ£€æŸ¥åœ¨å¼€å‘ç¯å¢ƒä¸­è¿›è¡Œï¼Œå®é™…ä¾èµ–ç”±æ„å»ºå·¥å…·ç®¡ç†</small>';
      container.innerHTML = html;
    }

    // è¿è¡Œæ‰€æœ‰æ£€æŸ¥
    function runAllChecks() {
      checkEnvironmentVariables();
      checkDependencies();
    }

    // é¡µé¢åŠ è½½å®Œæˆåè¿è¡Œæ£€æŸ¥
    document.addEventListener('DOMContentLoaded', runAllChecks);
  </script>
</body>
</html>